<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>So How Does the Internet Work, Anyway?</title><meta property="og:title" content="So How Does the Internet Work, Anyway?"><meta property="og:type" content="website"><meta property="og:description" content="I use the Internet a great deal, but until recently I've never really had a clear picture of what exactly makes it tick. Here is my attempt to put that to rest."><meta name="description" content="I use the Internet a great deal, but until recently I've never really had a clear picture of what exactly makes it tick. Here is my attempt to put that to rest."><link rel="canonical" href="https://blog.bithole.dev/internet.html"><link rel="stylesheet" href="static/stylesheets/main.css"><link rel="stylesheet" href="static/stylesheets/highlight-style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"></head><body><a href="/"><img src="static/images/banner0.jpg" alt="blog banner"></a><p id="date" class="date">January 4, 2022</p><h1 style="margin-top: 0">So How Does the Internet Work, Anyway?</h1><p>Some time ago, it occurred to me that I didn&#39;t <em>really</em> understand what made the Internet work. Sure, I am all too familiar with what the user experience is like, and my adventures in web development have forced me to acquire a fair bit of networking knowledge, but between the bits of light there existed vast chasms of confusion. So I decided to do some reading, some soul-searching, and publish my findings in the form of a blog post.</p>
<p>Please note that this post is by no means a comprehensive overview of <em>all</em> the technologies involved in the Internet; I only have one lifetime to waste, unfortunately. However, it does aim to at least touch on all of the most influential systems and organizations that allow the Internet to function. I probably won&#39;t cover the Internet&#39;s history in very much depth, either, though that is a fascinating topic that you should absolutely look into if you have any interest in networking.</p>
<p>The word &quot;internet&quot; itself offers some hints about its architecture. &quot;Internet&quot; is short for <em>internetworking</em>, the act of connecting multiple computer networks so that they can communicate. That&#39;s essentially what the Internet is, a bunch of independently maintained networks that are connected such that any two computers on the Internet can reach each other.</p>
<h2 id="a-word-on-layers">A Word on Layers <a class="section-link" href="#a-word-on-layers">&sect;</a></h2><p>The Internet is powered by an ever-expanding family of technologies and protocols. These systems are segregated into layers, and each layer is responsible for providing an interface that allows the next layer to do <em>its</em> job. This layered model serves as a great way to understand the Internet starting from the ground up. In reality, the divisions between these layers are not as concrete as one would hope, and as a result there is quite a bit of disagreement over how to best model the Internet stack (primarily between supporters of the OSI model and the TCP/IP model). Since this debate is incredibly contentious, I will do my best to avoid it.</p>
<h1 id="physical-layer">Physical Layer <a class="section-link" href="#physical-layer">&sect;</a></h1><p>Let&#39;s start from the very bottom. No Internet, no networks even. Consider two computers: how can digital data be transferred from one to another? The answer to this question is the <strong>physical layer</strong>, which describes how to transmit ones and zeroes over a physical transmission medium. On top of the physical layer lies the <strong>link layer</strong>, which leverages the physical layer&#39;s capabilities to transfer full <em>frames</em> of data over a network that may be more complicated than a single point-to-point link. (The link layer may also take on other responsibilities such as error correction and retransmission.)</p>
<div class="info-box">

<p>There isn&#39;t one idea of a &quot;frame&quot; since their implementation varies widly between protocols. However, for every network, there is a maximum frame size that it can accept, known as the <a href="https://en.wikipedia.org/wiki/Maximum_transmission_unit">maximum transmission unit</a> or MTU.</p>
</div>

<p>The physical layer and link layer are generally tightly coupled (out of necessity), which is the source of endless frustration. For example, the term &quot;Ethernet&quot; might refer to the physical cable standard, but it could also refer to the Ethernet protocol used to transfer frames over those cables.</p>
<p>The full answer is that Ethernet has many sublayers, which reside at varying levels within the physical and link layers. Twisted-pair Ethernet cables themselves are governed by a flock of partially agreeing standards; here&#39;s what <a href="https://en.wikipedia.org/wiki/Category_6_cable">Wikipedia</a> has to say about it:</p>
<blockquote>
<p>Confusion therefore arises because of the naming conventions and performance benchmarks laid down by the International ISO/IEC and American TIA/EIA standards, which in turn are different from the regional European standard, EN 50173-1. In broad terms, the ISO standard for Cat 6A is the most stringent, followed by the European standard, and then the American standard.</p>
</blockquote>
<p><em>That</em> is a mess that I have no interest in delving into. But Ethernet supports much more than just twisted-pair cables; it can be run over other physical media such as coaxial cable or  optical fiber. Those standards are managed by <a href="https://en.wikipedia.org/wiki/IEEE_802.3">IEEE 802.3</a>, which also handles the link-layer details of Ethernet. </p>
<p>Beyond Ethernet, there are no shortage of other ways to physically connect devices. Here are some prolific examples:</p>
<ul>
<li>WiFi (<a href="https://en.wikipedia.org/wiki/IEEE_802.11">IEEE 802.11</a>)</li>
<li>Cable (<a href="https://en.wikipedia.org/wiki/DOCSIS">DOCSIS</a>)</li>
<li><a href="https://en.wikipedia.org/wiki/LTE_(telecommunication)">LTE</a></li>
</ul>
<p>For every surviving technology, there are probably around ten dead ones. One example is <a href="https://en.wikipedia.org/wiki/Token_Ring">Token Ring</a>, IBM&#39;s Ethernet competitor that was famously vanquished around the turn of the century.</p>
<p>One thing that all <a href="https://en.wikipedia.org/wiki/IEEE_802">IEEE 802</a> technologies have in common is <strong>medium access control</strong> (<strong>MAC</strong>), which enables communication between devices on the same <strong>local area network</strong> (<strong>LAN</strong>). Each device (more accurately, each <a href="https://en.wikipedia.org/wiki/Network_interface_controller">interface</a>) is given a unique 48-bit address. These addresses are allocated by the IEEE to equipment manufacturers, though some mobile devices simply generate a <a href="https://support.apple.com/guide/security/wi-fi-privacy-secb9cb3140c/web">random MAC address</a> when connecting to a network to avoid being tracked. </p>
<p>Devices called <a href="https://en.wikipedia.org/wiki/Network_switch">network switches</a> allow communication between devices on the same LAN. A switch is basically an embedded device with a large number of Ethernet ports. Because all devices on the network communicate with each other by talking through the switch, a <a href="https://en.wikipedia.org/wiki/Star_network">star topology</a> is formed.</p>
<p><img src="static/images/switch-star-topology.png" alt="star topology diagram"></p>
<p><em>In case you can&#39;t tell, I&#39;m not exactly the best at making diagrams.</em></p>
<p>When computer A wants to send a message to computer B, it sends a frame to the switch; the frame header indicates that its destination is computer B&#39;s MAC address. However, the switch doesn&#39;t know which physical port the connection to computer B is located on, so it relays the frame to all connected computers, hoping that one of them is the intended recipient. When computer B receives the frame, it might reply with another frame. Since each frame has the sender&#39;s MAC address as well as the recipient&#39;s, when the switch receives a frame from computer B it will associate the port that computer B is connected on with computer B&#39;s MAC address, and in the future when the switch receives a frame with computer B as its destination it can simply relay the frame on the correct link instead of <em>flooding</em>.</p>
<div class="info-box">

<p>Back in the day, when everything was slightly worse, networks were often created using <a href="https://en.wikipedia.org/wiki/Ethernet_hub">hubs</a> instead of switches. Hubs are much simpler devices which simply retransmit everything that it receives to all other devices. Because of their relative lack of sophistication, hubs suffer from a littany of problems:</p>
<ul>
<li>Since every device needs to be able to receive the data being transmitted by the hub, if one device was slower than the others, <em>every</em> link on the switch would be forced to operate at that speed.</li>
<li>Multiple devices trying to transmit at the same time would result in a garbled mess being transmitted (a condition known as a <a href="https://en.wikipedia.org/wiki/Carrier-sense_multiple_access_with_collision_detection">collision</a>), requiring the hub to detect the conflict and temporarily stop all transmissions. This obviously degraded network performance.</li>
</ul>
<p>Today, hubs have been made obsolete in favor of switches and are rarely used outside of special conditions (though evidently my school&#39;s IT department hasn&#39;t gotten the memo). Even in the early days of Ethernet, it was apparent that collisions posed a challenging problem, so other protocols approached access control differently. For example, in Token Ring setups, there is no central switch or hub; nodes are connected in a ring, and transmission rights are passed around the ring. When one node is done transmitting, it passes the <em>token</em> to the next node. Hence the name, Token Ring. *roll credits*</p>
</div>

<p>Switches are one of the most ubiquitous building blocks of computer networks, so it&#39;s no surprise that they are all over the place. If your router has more than one Ethernet port, chances are it has a built-in switch.</p>
<h2 id="wifi">WiFi <a class="section-link" href="#wifi">&sect;</a></h2><p>An overview of physical-layer protocols just wouldn&#39;t be complete without a mention to WiFi, standardized by <a href="https://en.wikipedia.org/wiki/IEEE_802.11">IEEE 802.11</a>. The idea of a point-to-point link starts to break down when it comes to wireless communications because radio signals will propagate to every connected device whether you like it or not. Thus, WiFi networks use an algorithm called <a href="https://en.wikipedia.org/wiki/Multiple_Access_with_Collision_Avoidance">Multiple Access with Collision Avoidance</a> to ensure that only one device tries to transmit data at a time. Receiving frames is simpler; devices simply decode all incoming frames and pick out the ones that are actually destined towards their MAC address. In this way, a WiFi network functions more closely to an Ethernet hub than a switch.</p>
<p>In this situation, no router or switch is necessary to relay messages between devices on the same WLAN. In fact, any WiFi-capable transceiver can <a href="https://en.wikipedia.org/wiki/Wireless_ad_hoc_network">broadcast a network</a>; in fact, Windows <a href="https://answers.microsoft.com/en-us/windows/forum/all/how-do-i-set-up-an-ad-hoc-wifi-network-in-windows/0caa92d8-e02f-4e7f-aa5c-0abf10ed2039">natively supports</a> this feature! Instead, your router plays the role of a <a href="https://en.wikipedia.org/wiki/Wireless_access_point">wireless access point</a>, aptly abbreviated to <strong>WAP</strong>. (In light of &quot;WAP&quot; becoming rather vulgar in recent years, I will use the more succinct abbreviation of just <strong>AP</strong> for the rest of this post.) The role of an AP is simple; it just serves as an interface between the wireless network and the regular wired network, which has access to the public Internet. Speaking of which...</p>
<h1 id="internet-layer">Internet Layer <a class="section-link" href="#internet-layer">&sect;</a></h1><p>We&#39;ve finally reached the Internet layer of the Internet. This is where all the action happens! Buckle up, and let&#39;s explore how it works.</p>
<p>Relatively few protocols live in the Internet layer. Its primary inhabitants are the <a href="https://en.wikipedia.org/wiki/Internet_Protocol">Internet Protocol</a> (IP) and <a href="https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol">Internet Control Message Protocol</a> (ICMP). There are two currently deployed versions of IP, IPv4 and IPv6, which are generally very similar but vary in subtle yet important ways.</p>
<p>In IP, every network interface (usually just one per computer) is associated with an IP address. In IPv4, this address is 32-bits long, and usually written as a series of four numbers (each corresponding to a byte or <em>octet</em> of the IP address) separated by periods. For example, the IP of this blog at the time of writing is 142.93.26.121. IP addresses are managed by the <a href="https://en.wikipedia.org/wiki/Internet_Assigned_Numbers_Authority">Internet Assigned Numbers Authority</a>, which assigns blocks of IP addresses to the five <a href="https://en.wikipedia.org/wiki/Regional_Internet_registry">Regional Internet Registries</a>. The RIRs, in turn, deal with requests from individuals and businesses for IP allocations.</p>
<h2 id="ipv4-exhaustion">IPv4 Exhaustion <a class="section-link" href="#ipv4-exhaustion">&sect;</a></h2><p>Because IPv4 addresses are only 32 bits long, there can only be 2<sup>32</sup> = ~4 billion unique IPv4 addresses. That seems like a lot, but as early as the 90s the threat of <a href="https://en.wikipedia.org/wiki/IPv4_address_exhaustion">running out of IPv4 addresses</a> has continually loomed over the Internet, made worse by the fact that many parts of IPv4 space are <a href="https://en.wikipedia.org/wiki/Reserved_IP_addresses">reserved</a> for various purposes. To fix this issue, IPv6 was created. IPv6 addresses are 128 bits long, which is more than enough to serve humanity&#39;s needs at the moments. (If all IPv6 addresses were distributed equally among all living humans, every individual could have 47 octillion addresses. We won&#39;t be running out any time soon, especially because sadly a lot of the Internet is still stuck on IPv4.)</p>
<p><img src="static/images/xkcd-internet-map.jpg" alt="xkcd #195 internet map"></p>
<p><em><a href="https://xkcd.com/195/">xkcd 195</a>: A map of IPv4 space circa 2006. Things have only gotten more crowded since then.</em></p>
<div class="info-box">

<p><em>Why can&#39;t MAC addresses just be used for routing?</em>, you might ask. The biggest reason is that IP is meant to be mostly agnostic of the protocols used in the underlying link layer. Using MAC addresses would violate that principle; networks not running on IEEE 802 technologies wouldn&#39;t be able to join the Internet, which defeats its whole purpose of connecting numerous heterogeneous networks.</p>
</div>

<h2 id="packets">Packets <a class="section-link" href="#packets">&sect;</a></h2><p>One of the key innovations that made the Internet possible was <a href="https://en.wikipedia.org/wiki/Packet_switching">packet switching</a>, the idea of transferring digital data throughout a computer network by splitting it into chunks called <em>packets</em> and allowing nodes which receive packets to decide where to send the packet next so that it can reach the recipient. Thanks to its ubiquity, packet switching probably seems incredibly mundane and obvious to most programmers, but at the time (when the predominant paradigm for telecommunications was <a href="https://en.wikipedia.org/wiki/Circuit_switching">circuit switching</a>), packet switching was revolutionary. Compared to circuit switching, packet switching allows for much more diverse network topologies, and does not require all the packets in a single data stream to travel to the recipient via the same route, making Internet routing incredibly dynamic. All of these attributes have helped the Internet scale to billions of connected devices.</p>
<p>An IPv4 packet consists of two parts: a header, which provides information about the packet itself, and the data contained within the packet. Some of the info contained within the header includes:</p>
<ul>
<li>The destination address</li>
<li>The length of the packet&#39;s data</li>
<li>The <a href="https://en.wikipedia.org/wiki/Differentiated_services">type of data</a> in the packet, used by routers to determine how to best handle the packet (e.g. whether to prioritize latency or throughput)</li>
<li>A number identifying which protocol the underlying data is being used for; see the IANA <a href="https://www.iana.org/assignments/protocol-numbers/protocol-numbers.xhtml">list of protocol numbers</a>.</li>
<li>A <a href="https://en.wikipedia.org/wiki/Time_to_live">time to live</a> value, an integer which is decremented each time the packet is retransmitted until it reaches zero, at which point the packet is dropped. Used to prevent unroutable packets from being circulated infinitely.</li>
<li>The checksum of the header, to detect whether it was corrupted during transit. Integrity of the packet payload is not handled by IP; that responsibility is delegated to whatever protocol is built on top of IP.</li>
<li>Fragmentation information. A router may break an IP packet into fragments for various reasons, usually to fit into the MTU of the link between the router and the next recipient. Packet fragments contain their offset within the original packet and a bitfield indicating whether there are more fragments, allowing for seamless reassembly along the packet&#39;s route.</li>
</ul>
<p>So how exactly do IP packets find their way to their final destination? That&#39;s a big question. Let&#39;s figure it out.</p>
<h2 id="ip-in-the-lan">IP in the LAN <a class="section-link" href="#ip-in-the-lan">&sect;</a></h2><p>Before concerning ourselves with the public Internet in all of its grandeur, let&#39;s consider how IP works on a single local network first. Let&#39;s check up on our little four-computer network from earlier.</p>
<p><img src="static/images/ip-lan.png" alt="diagram of an IP LAN"></p>
<p><em>Assume that each computer has been assigned a static IP address.</em></p>
<p>Suppose computer 10.0.0.2 wants to send a message to 10.0.0.3. In order to actually deliver a message to 10.0.0.3, our sender needs to know which MAC address to send packets to. It can obtain this information via the <a href="https://en.wikipedia.org/wiki/Address_Resolution_Protocol">Address Resolution Protocol</a> (ARP).</p>
<h2 id="address-resolution-protocol">Address Resolution Protocol <a class="section-link" href="#address-resolution-protocol">&sect;</a></h2><p>ARP is a protocol that enables the resolution of IP addresses to MAC addresses on a network. It operates on the link-layer. When a computer needs to determine the MAC address given an IP address, it broadcasts an ARP request to the local network. This is done by sending frames to a MAC address of FF:FF:FF:FF:FF:FF, which signals to the switch that the message should be relayed to all connected devices. The device which has the corresponding IP responds to the request with its MAC and IP address. Both of these devices may cache each others&#39; IP and MAC addresses to avoid needing to make another ARP request in the future.</p>
<p>There also exists a second method for the discovery of IP-to-MAC mappings. Under certain circumstances, such as when a device joins a network or obtains a new IP address, it may publish an ARP announcement that prompts all other devices to update their ARP caches.</p>
<div class="info-box">

<p>One major weakness of ARP is its vulnerability to <a href="https://en.wikipedia.org/wiki/ARP_spoofing">spoofing attacks</a>, wherein a malicious device publishes an ARP announcement or responds to an ARP request not intended for them in order to masquerade as another device. For this reason, IPv6 uses <a href="https://en.wikipedia.org/wiki/Neighbor_Discovery_Protocol">Neighbor Discovery Protocol</a> (NDP) instead of ARP. NDP seeks to address some of the security and usability problems which have traditionally affected ARP. To learn more, check out <a href="https://superuser.com/questions/969831/why-is-arp-replaced-by-ndp-in-ipv6">this thread</a> on StackExchange.</p>
</div>

<p>ARP is ubiquitous among IEEE 802 networks. If your computer is on a WiFi or Ethernet-based network, you can install <a href="https://www.wireshark.org/">Wireshark</a> and observe ARP requests happening right before your eyes.</p>
<p><img src="static/images/arp-capture.png" alt="arp requests on my LAN, as seen by wireshark"></p>
<p><em>Some ARP requests seen on my local network.</em></p>
<p>Your computer doesn&#39;t make an ARP request for every single outgoing IPv4 connection. If configured correctly, your computer should be able to tell which addresses belong to the local network (i.e. they can be reached by MAC address) and which reside on the public internet. </p>
<h2 id="introduction-to-cidr">Introduction to CIDR <a class="section-link" href="#introduction-to-cidr">&sect;</a></h2><p>During the Internet&#39;s infancy, the format of IP addresses was much simpler. As seen in <a href="https://datatracker.ietf.org/doc/html/rfc760#section-3.1">RFC 760</a>, published in January 1980, the first 8 bits of each IP address identified which network it originated from, and the remaining 24 bits were unique to each host. This limited the Internet to just 256 networks (technically 254 since addresses beginning with 0 are reserved for local use and addresses beginning with 255 are used for broadcast). It soon become apparent that the Internet would grow to encompass much more than just 256 networks, so the <a href="https://en.wikipedia.org/wiki/Classful_network">classful network</a> scheme was adopted.</p>
<p>Under classful networking, each network belongs to one of three classes:</p>
<ul>
<li>Class A: The first 8 bits of the IP address identify the network, leaving 24 bits = 16,777,216 addresses for host identification.</li>
<li>Class B: The first 16 bits of the IP address identify the network, leaving 16 bits = 65,536 addresses for host identification.</li>
<li>Class C: The first 24 bits of the IP address identify the network, leaving 8 bits = 256 addresses for host identification.</li>
</ul>
<p>(The actual scheme was slightly more complex.)</p>
<p>Eventually, engineers realized that the classful networking scheme was still rather inefficient; the size difference between classes was far too granular, and many IP addresses were going to waste. So classful networks were done away with, and a new system, <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing">Classless Inter-Domain Routing</a> (CIDR), was adopted.</p>
<p>Under CIDR, the number of network/host bits is variable, instead of being fixed at 8, 16, or 24. This allowed IPs to be allocated with much less overhead. In CIRD notation, the length of the network prefix is written after the IP and separated with a slash. For example, the IP of this server at the time of writing is 142.93.26.121. It belongs to a bigger subnet, 142.93.16.0/20, which encompasses all IP addresses whose first 20 bits match those of 142.93.16.0. The length of this network&#39;s prefix is 20 bits, giving it a maximum capacity of 2<sup>12</sup> = 4096 hosts.</p>
<p>Complementary to CIDR is the idea of a <em>netmask</em>. For a given classless network, its netmask is a special 32-bit value where all the prefix bits are set to 1 while all the host bits are cleared. The routing prefix of an address can be obtained by finding the bitwise AND of an address and the netmask. If the routing prefix of an address doesn&#39;t match that of the local network, your computer won&#39;t perform an ARP lookup, since only machines on the same LAN can be contacted via MAC address.</p>
<div class="info-box">

<p>Check out my <a href="https://bithole.dev/tools/cidr.html">CIDR calculator</a>, which performs a number of useful operations given a CIDR range.</p>
</div>

<h2 id="going-public">Going Public <a class="section-link" href="#going-public">&sect;</a></h2><p>So what happens when your computer encounters an IP that isn&#39;t on the LAN? Thankfully for your poor computer, handling the routing of this packet across the public Internet is mostly outside of its responsibilities. Your computer has a <a href="https://en.wikipedia.org/wiki/Default_route">default route</a>, which specifies who to contact to relay packets outside the local network. That device is called the <strong>default gateway</strong>, since it serves as a gateway to the rest of the world.</p>
<div class="info-box">

<p>Your computer uses the default gateway&#39;s IP (which can be printed via undefined on Windows or undefined on Linux) to figure out its MAC address. However, the IP packets sent to the default gateway still have the final recipient&#39;s IP address, since obviously the default gateway needs to know who to send it to.</p>
<p>Many residential routers also serve a management page from the default gateway IP address. This is purely by convention. The router can distinguish traffic to the gateway itself and traffic to the public internet by looking at the destination address of incoming packets.</p>
</div><script src="https://utteranc.es/client.js" crossorigin="anonymous" repo="adrian154/blog" issue-term="title" label="blog-post-comments" theme="github-light"></script><p class="footnote">&copy; 2022 Adrian Zhang &bull; <a href="https://bithole.dev/">about me</a> &bull; <a href="https://github.com/adrian154/blog">contribute</a></p></body></html>