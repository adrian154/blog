<!DOCTYPE html><html lang="en" class="serif"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Detecting Users' DNS Resolvers</title><meta property="og:title" content="Detecting Users' DNS Resolvers"><meta property="og:type" content="website"><meta property="og:description" content="Utilizing DNS tomfoolery for fun and profit. Well, actually, just fun."><meta name="description" content="Utilizing DNS tomfoolery for fun and profit. Well, actually, just fun."><link rel="stylesheet" href="/stylesheets/highlight-style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"><link rel="stylesheet" href="/stylesheets/main.css"><link rel="stylesheet" href="styles.css"><script>const loadSetting = name => {
    if(localStorage.getItem(name) === "true")
        document.documentElement.classList.add(name);
    else
        document.documentElement.classList.remove(name);
};

loadSetting("serif");
loadSetting("darkmode");</script><script defer src="/scripts/ui.js"></script><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="canonical" href="https://blog.bithole.dev/blogposts/detecting-dns-resolvers"></head><body><header><a href="/"><img src="/images/banner.jpg" alt="blog banner"></a></header><main><p id="date" class="date">July 24, 2022</p><h1 style="margin-top: 0">Detecting Users' DNS Resolvers</h1><nav><div id="contents"><p>Table of Contents</p><a href="#how"><p>How?</p></a><a href="#applications"><p>Applications</p></a></div><button id="show-toc">&#9776; Contents</button></nav><p>Let&#39;s say someone has visited your website; is it possible to determine what DNS resolvers their computer is configured to use?</p>
<p>Well, yes. Of course you can! This blogpost wouldn&#39;t be very long if the answer was no. Let&#39;s find out how. But before we begin...</p>
<p><button id="button">Find My Resolvers</button></p>
<p><noscript>You&#39;ll need JavaScript for this to work.</noscript></p>
<div id="resolvers">
</div>

<p>Note that if your DNS resolver uses <a href="https://en.wikipedia.org/wiki/Anycast">anycast</a>, the IPs found here will not match the ones in your configuration. This is because those resolvers send out their queries on a separate non-anycast interface, to make sure that responses from nameservers are routed correctly. </p>
<script>

const randomid = () => {
    let str = "";
    for(let i = 0; i < 32; i++) {
        str += "abcdefghijklmnopqrstuvwxyz"[Math.floor(Math.random()*26)];
    }
    return str; 
};

const resolvers = document.getElementById("resolvers");

document.getElementById("button").addEventListener("click", async event => {
    
    resolvers.replaceChildren();
    const set = new Set();
    event.target.disabled = true;

    // keep track of # of requests since a new resolver was discovered
    let i = 0;

    while(true) {

        // hmm
        const name = `${randomid()}.g4vmltbq.xyz.`
        await fetch(`https://${name}/`).catch(() => {});
        
        i++;

        // retrieve who did it
        const resp = await (await fetch(`https://apis.bithole.dev/dns-query-addrs?name=${encodeURIComponent(name)}`)).json();
        for(const addr of resp) {
            if(set.has(addr)) continue;
            i = 0;
            set.add(addr);
            const span = document.createElement("span");
            span.textContent = addr;
            resolvers.append(span);
        }

        // stop if we've made 5 requests and no new resolvers found
        if(i == 10) {
            break;
        }

    }

    event.target.disabled = false;

});


</script>

<h1 id="how">How? <a class="section-link" href="#how">&sect;</a></h1><p>Earliest this year, I wrote an incomplete implementation of the DNS protocol in NodeJS to create a <a href="https://bithole.dev/tools/dns/">tool</a> for tracing DNS delegations in the browser. I soon realized that I could probably create a very rudimentary DNS server with what I had. Fast-forward to this morning, when I got the idea for identifying the user&#39;s resolvers by logging requests to the DNS server. And thus, I got to coding.</p>
<p>The code for the server is actually remarkably simple. In fact, pretty much all the logic is contained in a single method.</p>
<pre><code class="hljs">server.<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-function">(<span class="hljs-params">data, rinfo</span>) =&gt;</span> {

    <span class="hljs-keyword">const</span> reader = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">DNS</span>.<span class="hljs-title class_">DNSReader</span>(data);
    <span class="hljs-keyword">const</span> message = <span class="hljs-variable constant_">DNS</span>.<span class="hljs-property">DNSMessage</span>.<span class="hljs-title function_">read</span>(reader);
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">DNS</span>.<span class="hljs-title class_">DNSBuilder</span>();
    response.<span class="hljs-title function_">writeUInt16BE</span>(message.<span class="hljs-property">id</span>);
    response.<span class="hljs-title function_">writeUInt16BE</span>(<span class="hljs-variable constant_">DNS</span>.<span class="hljs-property">FLAG</span>.<span class="hljs-property">AUTHORITATIVE</span> | <span class="hljs-variable constant_">DNS</span>.<span class="hljs-property">FLAG</span>.<span class="hljs-property">RESPONSE</span>);

    <span class="hljs-keyword">const</span> answers = message.<span class="hljs-property">questions</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">question</span> =&gt;</span> question.<span class="hljs-property">type</span> == <span class="hljs-variable constant_">DNS</span>.<span class="hljs-property">RECORD_TYPE</span>.<span class="hljs-property">A</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">question</span> =&gt;</span> question.<span class="hljs-property">domain</span>);

    response.<span class="hljs-title function_">writeUInt16BE</span>(message.<span class="hljs-property">questions</span>.<span class="hljs-property">length</span>) <span class="hljs-comment">// # questions</span>
            .<span class="hljs-title function_">writeUInt16BE</span>(answers.<span class="hljs-property">length</span>) <span class="hljs-comment">// # answers</span>
            .<span class="hljs-title function_">writeUInt16BE</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">writeUInt16BE</span>(); <span class="hljs-comment">// no NS/additional records</span>

    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">const</span> question <span class="hljs-keyword">of</span> message.<span class="hljs-property">questions</span>) {
        <span class="hljs-variable constant_">DNS</span>.<span class="hljs-property">Question</span>.<span class="hljs-title function_">write</span>(response, question);
    }

    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">const</span> name <span class="hljs-keyword">of</span> answers) {
        response.<span class="hljs-title function_">writeDomainName</span>(name);
        response.<span class="hljs-title function_">writeUInt16BE</span>(<span class="hljs-variable constant_">DNS</span>.<span class="hljs-property">RECORD_TYPE</span>.<span class="hljs-property">A</span>);
        response.<span class="hljs-title function_">writeUInt16BE</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// class 1 (IN)</span>
        response.<span class="hljs-title function_">writeUInt32BE</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 0 TTL</span>
        response.<span class="hljs-title function_">writeUInt16BE</span>(<span class="hljs-number">4</span>);
        response.<span class="hljs-title function_">writeUInt8</span>(<span class="hljs-number">142</span>).<span class="hljs-title function_">writeUInt8</span>(<span class="hljs-number">93</span>).<span class="hljs-title function_">writeUInt8</span>(<span class="hljs-number">26</span>).<span class="hljs-title function_">writeUInt8</span>(<span class="hljs-number">121</span>);

        <span class="hljs-keyword">const</span> list = queries.<span class="hljs-title function_">get</span>(name) || [];
        list.<span class="hljs-title function_">push</span>(rinfo.<span class="hljs-property">address</span>);
        queries.<span class="hljs-title function_">set</span>(name, list);
    }

    <span class="hljs-keyword">const</span> buf = response.<span class="hljs-title function_">build</span>();
    server.<span class="hljs-title function_">send</span>(buf, <span class="hljs-number">0</span>, buf.<span class="hljs-property">length</span>, rinfo.<span class="hljs-property">port</span>, rinfo.<span class="hljs-property">address</span>);

});</code></pre><p>As you can see, this server is not very smart. The only thing it is capable of is blindly responding to all A requests with a fixed IP. However, for our case, that&#39;s sufficient.</p>
<p>The client code is even simpler. If you open up the network tab for this page and click the button again, you can see it at work; it simply generates a long random domain name, triggers a DNS query for that domain by initiating a request via <code>fetch</code>, and asks our crappy DNS server about which IPs have queried for those domains. To make it all work, I bought a cheap domain (g4vmltbq.xyz) and added a wildcard NS record pointing resolvers to my DNS server.</p>
<h1 id="applications">Applications <a class="section-link" href="#applications">&sect;</a></h1><p>What could this be useful for? I have no idea, to be honest, but I would like to hear what you think in the comments :)</p>
<img id="img-view" style="display: none"><h1>Comments</h1><noscript><b>Please enable Javascript to view the comments on this post.</b></noscript><script src="https://utteranc.es/client.js" crossorigin="anonymous" repo="adrian154/blog" issue-term="title" label="blog-post-comments" theme="preferred-color-scheme"></script></main><footer><p>&copy; 2022 <a href="https://bithole.dev/">Adrian Zhang</a> &bull; <a href="/rss.xml">rss</a> &bull; <a href="https://github.com/adrian154/blog">source</a> &bull; <a href="https://creativecommons.org/licenses/by-sa/3.0/legalcode">CC BY-SA 3.0</a></p></footer></body></html>