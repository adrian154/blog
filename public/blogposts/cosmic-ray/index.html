<!DOCTYPE html><html lang="en" class="serif"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Taking Pictures of Cosmic Rays</title><meta property="og:title" content="Taking Pictures of Cosmic Rays"><meta property="og:type" content="website"><meta property="og:description" content="Turn your camera into a radiation detector!"><meta name="description" content="Turn your camera into a radiation detector!"><link rel="stylesheet" href="/stylesheets/highlight-style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"><link rel="stylesheet" href="/stylesheets/main.css"><script>const loadSetting = name => {
    if(localStorage.getItem(name) === "true")
        document.documentElement.classList.add(name);
    else
        document.documentElement.classList.remove(name);
};

loadSetting("serif");
loadSetting("darkmode");</script><script defer src="/scripts/ui.js"></script><link rel="icon" type="image/png" sizes="16x16" href="/favicon.png"><link rel="canonical" href="https://blog.bithole.dev/blogposts/cosmic-ray"></head><body><header><p><a id="home-link" href="/">Â« more posts</a></p><h1 id="post-title">Taking Pictures of Cosmic Rays</h1></header><main><p>A blogpost? In this economy?! Yes, that&#39;s right. Today, we&#39;re going to be looking at how you can use an unmodified digital camera to detect cosmic rays and other charged particles.</p>
<p>{TODO: Cosmic rays}</p>
<p>First, what <em>is</em> a cosmic ray? Put simply, they&#39;re not actually &quot;rays&quot;; rather, they are high-energy particles, usually protons, that have found their way to Earth. Some come from the Sun, while others originate from outside our Solar System or even other galaxies.</p>
<p>The original particle is called the primary cosmic ray, and it almost never makes it to the surface. Instead, when it collides with atoms in the atmosphere, a shower of secondary particles is produced. These particles are the ones which we&#39;ll be detecting. </p>
<p>To actually observe these particles, we&#39;ll be using a plain old digital camera. The silicon detector it uses to record the intensity of light is also sensitive to radiation; when charged particles pass through the sensor, electrons are ripped from the atoms of the photosites, producing charges that can be read out just like a regular image. This effect is sometimes seen as a white speckle pattern in photos of radioactive samples.</p>
<figure style="max-width: 500px">
    <img loading="lazy" src="rad-meme.jpg" alt="photo of radiation source with white dots">
    <figcaption>&#9835; Dumb ways to die, so many dumb ways to die... &#9835;</figcaption>
</figure>

<p>Anyways, the procedure is very simple. Just put the lens cap on your camera, put it in a dark place with the sensor facing the zenith (straight up), and leave it to take some pictures. With a little luck, you&#39;ll be greeted by some cosmic ray tracks in your images when you come back!</p>
<p>A few words about camera settings:</p>
<ul>
<li>In theory, a shorter exposure length offers many advantages, such as increased temporal resolution and less dark current. However, this comes at the cost of more data to process. I also didn&#39;t want to cause too many shutter actuations, so I settled for an exposure length of 1 minute.</li>
<li>I used an ISO of 200, which corresponds to unity gain (i.e. 1 electron equals 1 ADU) on my camera. ISO 100 would probably work well too. In general, a lower ISO is preferred since read noise is not a significant concern.</li>
</ul>
<p>One last tidbit: my camera, a Nikon D7000, applies some transformations to raw images such as black-point subtraction and channel scaling. This is great for regular photography, but it will screw up our data. Thankfully, there is a free <a href="https://nikonhacker.com/viewtopic.php?t=2319">tool</a> that uses USB commands to disable these adjustments.</p>
<p>As a bonus, this hack will also make the camera include the optical black pixels in the saved image. These pixels reside on the edge of the sensor and are blocked from receiving any light. Normally, they are used to calibrate the sensor&#39;s black point and are cropped from the final image, but cosmic rays can pass right through the opaque layer. Thus, we actually gain a tiny bit of extra detector area. </p>
<h1 id="post-processing">Post-processing <a class="section-link" href="#post-processing">&sect;</a></h1><p>I left my camera snapping away overnight, and woke up to 348 images. Let&#39;s open them up and take a look!</p>
<p>Upon first inspection, the images look totally black, which is hardly surprising. You took a picture with the lens cap on. What did you expect? </p>
<p>If we crank up the exposure a lot, some patterns start to appear:</p>
<p><img loading="lazy" src="hot-pixels.png" alt="hot pixels"></p>
<p>Wow, are those all cosmic rays? <em>No.</em> If you open up another exposure and go to the same spot, you will see the exact same patterns.</p>
<p>What we&#39;re dealing with is hot pixels. Every photosite will spontaneously produce electrons even in the absence of light due to thermal fluctuations; this signal is known as <em>dark current</em>. For most pixels, this is contained at about 0.1 electrons per second. However, due to flawed manufacturing, some pixels exhibit much higher dark current than others, manifesting as hot pixels.</p>
<p>It can be difficult to distinguish a hot pixel from a cosmic ray using just one frame of data, so instead we analyze the value of a pixel across multiple frames to check for anomalies. Hot pixels will show a consistent value in every frame, while a genuine cosmic ray hit will stand out.</p>
<p>Okay, so let&#39;s write some code to go through all the images. First, however, we must convert them to a format that we can read. My camera outputs images in Nikon&#39;s proprietary NEF format, which is not very amenable to manipulation. Luckily, there&#39;s an open-source tool called <a href="https://www.dechifro.org/dcraw/">dcraw</a> which will take our NEFs and produce <a href="https://en.wikipedia.org/wiki/Netpbm">PGMs</a>, which are basically just a short header followed by uncompressed pixel data.</p>
<p>If you are replicating my experiment, here is an example dcraw invocation:</p>
<pre><code class="hljs">dcraw -4 -D *.NEF</code></pre><ul>
<li><code>-4</code>: output linear 16-bit values</li>
<li><code>-D</code>: output a grayscale image</li>
</ul>
<p>These flags are very important. dcraw is designed to work with photographic data, so it will normally apply some adjustments to convert the raw data into a viewable image. For example, in order to record color, every photosite in the camera sensor is covered with a tinted filter in a <a href="https://en.wikipedia.org/wiki/Color_filter_array">repeating pattern</a>.</p>
<p><img loading="lazy" src="bayer-matrix.png" alt="illustration of color filter array"></p>
<p>dcraw will assign each pixel an (R,G,B) value by interpolating based on its neighbors, a process called <a href="https://en.wikipedia.org/wiki/Demosaicing">demosaicing</a>. However, the particles we&#39;re looking for aren&#39;t affected by the colored filters, so demosaicing will merely distort the data and thus must be avoided.</p>
<h2 id="anomaly-detection">Anomaly Detection <a class="section-link" href="#anomaly-detection">&sect;</a></h2><p>Disclaimer: my statistics knowledge pretty much peaked with AP Stats and has been going downhill since. So I&#39;m pretty much spitballing here. Beware!</p>
<p>In the absence of cosmic rays, the only signal we expect to observe is the dark current, which varies randomly due to <a href="https://en.wikipedia.org/wiki/Shot_noise">shot noise</a>. Shot noise follows a Poisson distribution, approaching a normal distribution under our conditions.</p>
<p><img loading="lazy" src="pixel-value-dist.png" alt="pixel value distribution showing bell curve"></p>
<p>Normality is confirmed by a normal probability plot:</p>
<p><img loading="lazy" src="normal-probability-plot.png" alt="normal probability plot showing linear distribution"></p>
<p>Incidentally, I totally forgot how to do these, so I wrote a short explanatory <a href="/blogposts/normality-plot/">blogpost</a> to refresh my memory.</p>
<p>Knowing all this, we can calculate a z-score for every sample, which essentially represents the number of standard deviations separating it from the mean. If this value is above a certain threshold, we mark the pixel in that frame as anomalous. I chose a cutoff of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mo>=</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">z = 6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">6</span></span></span></span>; theoretically, the odds of observing a value that extreme due to random variation alone are well below one in a billion. In reality, due to increasing dark current as the sensor heats up, the pixel values are not truly normally distributed and there will be occasional false positives.</p>
<p>In order to determine the z-scores, we must first compute the mean and standard deviation of each pixel. This turns out to be a bit problematic, since a na&iuml;ve algorithm requires all the values of the sample to be in memory. Unfortunately, the 11 GB of data we collected is a little too big for me to fit into memory. While there are <a href="https://en.wikipedia.org/wiki/Algorithms_for_calculating_variance#Welford&#39;s_online_algorithm">algorithms</a> capable of computing mean and variance one value at a time in a single pass, I opted to calculate the sample mean and then the sum of the squared differences. This has the benefit of allowing me to remove the value in consideration from the mean and variance, preventing outliers from distorting the sample statistics.</p>
<aside>

<p>This is done based on the assumption that there will never be more than one outlier per pixel, which is reasonable considering that there are 17 million pixels per frame.</p>
</aside>

<p>The two-pass solution is slower, but by saving the computed values to a file and reusing it in subsequent analysis the computational cost is <a href="https://en.wikipedia.org/wiki/Amortized_analysis">amortized</a>. <s>Also, I have an SSD, so none of this is really relevant.</s></p>
<p>After identifying the anomalies, I grouped them into clusters by simply finding all other anomalies within a 16-pixel radius. This worked remarkably well, and allowed me to quickly find the most extensive cosmic ray patterns.</p>
<h1 id="results">Results <a class="section-link" href="#results">&sect;</a></h1><aside>

<p>The raw data is available as CSV <a href="anomalies.csv">here</a>. The <code>value</code> column is the difference between the pixel&#39;s observed value and the mean for that pixel.</p>
</aside>

<p>At a confidence level of 6 sigma, I was left with 15,150 anomalous pixels and 2,083 clusters of at least size 2. At approximately one muon per cm<sup>2</sup> per minute, this is higher than the expected value of about 1,300 cosmic rays. This disparity can be explained by the fact that some of the particles may be of terrestrial origin (i.e. ambient radioactive decay).</p>
<p>Cluster size appears to follow an exponential distribution:</p>
<p><img loading="lazy" src="cluster-size-distribution.png" alt="cluster size histogram showing that larger sizes rapidly become more uncommon"></p>
<p>And without further ado... some images!</p>
<p><img loading="lazy" src="collage.png" alt="5x5 collage of cosmic rays"></p>
<p>What are these particles? The curved particles (&quot;worms&quot;) are most likely electrons; their low mass makes them easily deflected, hence the curved trajectories. These electrons may be the result of Compton scattering of gamma rays produced by the decay of naturally occuring radionuclides, or they might be produced the direct result of beta decay.</p>
<p><img loading="lazy" src="worm.png" alt="curved electron path"></p>
<p>The straight paths are most likely muons, produced by high-altitude air showers due to cosmic rays. </p>
<h1 id="bonus-round">Bonus Round <a class="section-link" href="#bonus-round">&sect;</a></h1><p>Dark current is proportional to temperature. Therefore, to reduce dark current, we must cool the camera. My camera doesn&#39;t have any built-in cooling capabilities, so I needed an external source of cooling. Thankfully, I already have such an appliance.</p>
<p>{TODO:Photo of camera in freezer}</p>
<p>Putting the camera in the freezer has the </p>
<img id="img-view" style="display: none"></main><footer><p>&copy; 2022 <a href="https://bithole.dev/">Adrian Zhang</a> &bull; <a href="/rss.xml">rss</a> &bull; <a href="https://github.com/adrian154/blog/tree/main/public/blogposts/cosmic-ray">source</a> &bull; <a href="https://creativecommons.org/licenses/by-sa/3.0/legalcode">CC BY-SA 3.0</a></p></footer></body></html>